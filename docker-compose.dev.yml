version: '3'

services:
    app:
        build: .
        environment: &django_env
            REDIS_URL: redis://redis:6379
            CLICKHOUSE_HOST: clickhouse 
            CLICKHOUSE_DATABASE: default 
            CLICKHOUSE_USER: default 
            CLICKHOUSE_PASSWORD: "" 
            CLICKHOUSE_CLUSTER: default 
            CLICKHOUSE_SECURE: false 
            CLICKHOUSE_VERIFY: false 
            CLICKHOUSE_CA: "" 
        command:
            - bash
            - -c
            - |
                python manage.py migrate
                python manage.py runserver 0.0.0.0:8000
        volumes:
            - .:/code
        ports:
            - '8000:8000'
    web:
        build: ./frontend
        ports:
            - "3000:3000"

    redis:
        image: redis:6.2.7-alpine
        restart: on-failure
        ports:
            - '6388:6379'
        command: redis-server --maxmemory-policy allkeys-lru --maxmemory 200mb

    worker:
        build: .
        environment:
            <<: *django_env
        command:
            - ./bin/celery
        volumes:
           - .:/code
    
    clickhouse:
        image: ${CLICKHOUSE_SERVER_IMAGE:-clickhouse/clickhouse-server:23.4.2.11}
        restart: on-failure
        depends_on:
            - zookeeper
    
    zookeeper:
        image: zookeeper:3.7.0
        restart: on-failure 